<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tiling Estimator</title>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }
    .container {
      width: 95%;
      max-width: 750px;
      padding: 20px;
      margin-top: 20px;
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 10px;
    }
    h2, h3 { text-align: center; }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin: 6px 0 12px 0;
      background: #2a2a2a;
      color: #fff;
      border: 1px solid #444;
      font-size: 16px;
      border-radius: 4px;
    }
    .hidden { display: none; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    th, td { border: 1px solid #555; padding: 8px; text-align: center; }
    ul { list-style: none; padding: 0; }
    ul li {
      display: flex;
      justify-content: space-between;
      background: #2a2a2a;
      padding: 6px 10px;
      border-radius: 5px;
      margin-bottom: 4px;
      align-items: center;
    }
    ul li span button, .action-btn {
      font-size: 12px;
      padding: 6px 10px;
      margin: 4px 2px;
      border-radius: 4px;
      background: #fff;
      color: #000;
      border: none;
      cursor: pointer;
      width: 100%;
    }
    .action-btn-container { display: flex; flex-direction: column; gap: 5px; }
    #thankYouMessage { text-align: center; font-size: 18px; margin-top: 20px; }
    @media print {
      button, #restartBtn { display: none !important; }
      body, .container { background: #fff !important; color: #000 !important; }
      #thankYouMessage { display: block; }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- PAGE 1 -->
  <div id="page1">
    <h2>Tiling Estimator</h2>
    <label for="name">Full Name</label>
    <input type="text" id="fullName" placeholder="Enter your name">
    <label for="email">Email Address</label>
    <input type="email" id="email" placeholder="Enter your email">
    <h3>Add Rooms</h3>
    <input type="text" id="roomName" placeholder="e.g. Living Room">
    <button onclick="addRoom()">Add Room</button>
    <ul id="roomList"></ul>
    <button onclick="goToPage2()">Next</button>
  </div>

  <!-- PAGE 2 -->
  <div id="page2" class="hidden">
    <h2>Enter Room Dimensions</h2>
    <label>Unit</label>
    <select id="unit" onchange="renderRoomDimension()">
      <option value="meters">Meters</option>
      <option value="feet">Feet</option>
    </select>
    <div id="roomDimensionForm"></div>
    <button onclick="backToPage1()">Back</button>
  </div>

  <!-- PAGE 3 -->
  <div id="previewPage" class="hidden">
    <h2>Preview</h2>
    <table id="previewTable">
      <thead>
        <tr><th>Room</th><th>Length</th><th>Width</th><th>Tile Size</th><th>Boxes</th><th>Action</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="requestQuotation()">Request Quotation (KES 200)</button>
  </div>

  <!-- PAGE 4 -->
  <div id="resultSection" class="hidden">
    <h2>Quotation</h2>
    <div id="result"></div>
    <p id="thankYouMessage">Thank you for using our tiling estimator!</p>
    <button onclick="window.print()">Print</button>
    <button id="restartBtn" onclick="restartApp()">Make Another</button>
  </div>
</div>

<script>
  let user = {}, rooms = [], roomData = [], currentRoom = 0;
  const FEET_TO_METERS = 0.3048;

  function addRoom() {
    const name = document.getElementById('roomName').value.trim();
    if (!name || rooms.includes(name)) return alert("Enter a unique room name.");
    rooms.push(name);
    roomData.push({ name });
    renderRooms();
    document.getElementById('roomName').value = "";
  }

  function renderRooms() {
    const list = document.getElementById('roomList');
    list.innerHTML = "";
    rooms.forEach((r, i) => {
      list.innerHTML += `<li>${r}<span>
        <button onclick="editRoomName(${i})">Edit</button>
        <button onclick="removeRoom(${i})">Remove</button>
      </span></li>`;
    });
  }

  function removeRoom(i) {
    rooms.splice(i, 1);
    roomData.splice(i, 1);
    renderRooms();
  }

  function editRoomName(i) {
    const newName = prompt("Enter new room name", rooms[i]);
    if (newName && !rooms.includes(newName)) {
      rooms[i] = newName;
      roomData[i].name = newName;
      renderRooms();
    } else if (rooms.includes(newName)) {
      alert("Room name must be unique.");
    }
  }

  function goToPage2() {
    user.name = document.getElementById('fullName').value.trim();
    user.email = document.getElementById('email').value.trim();
    const emailPattern = /\S+@\S+\.\S+/;
    if (!user.name || !emailPattern.test(user.email) || rooms.length === 0) {
      return alert("Complete all fields and add at least one room.");
    }
    currentRoom = 0;
    document.getElementById('page1').classList.add('hidden');
    document.getElementById('page2').classList.remove('hidden');
    renderRoomDimension();
  }

  function backToPage1() {
    document.getElementById('page2').classList.add('hidden');
    document.getElementById('page1').classList.remove('hidden');
  }

  function renderRoomDimension() {
    const r = rooms[currentRoom];
    const u = document.getElementById('unit').value;
    const label = u === 'feet' ? 'ft' : 'm';
    const existing = roomData[currentRoom];
    document.getElementById('roomDimensionForm').innerHTML = `
      <h3>${r}</h3>
      <label>Length (${label})</label><input type="number" id="length" value="${existing.length || ''}">
      <label>Width (${label})</label><input type="number" id="width" value="${existing.width || ''}">
      <label>Tile Length (${label})</label><input type="number" id="tileLength" value="${existing.tileLength || ''}">
      <label>Tile Width (${label})</label><input type="number" id="tileWidth" value="${existing.tileWidth || ''}">
      <label>Gap Size</label><input type="number" id="groutSize" value="${existing.groutSize || 0}">
      <select id="groutUnit">
        <option value="cm" ${existing.groutUnit === 'cm' ? 'selected' : ''}>centimeters</option>
        <option value="in" ${existing.groutUnit === 'in' ? 'selected' : ''}>inches</option>
      </select>
      <label>Tiles Per Box</label><input type="number" id="tilesPerBox" value="${existing.tilesPerBox || ''}">
      <button onclick="saveRoomDimension()">Save Room Data</button>
    `;
  }

  function saveRoomDimension() {
    const conv = document.getElementById('unit').value === 'feet' ? FEET_TO_METERS : 1;
    let l = parseFloat(document.getElementById('length').value) * conv || 0;
    let w = parseFloat(document.getElementById('width').value) * conv || 0;
    let tl = parseFloat(document.getElementById('tileLength').value) * conv || 0;
    let tw = parseFloat(document.getElementById('tileWidth').value) * conv || 0;
    const groutSize = parseFloat(document.getElementById('groutSize').value) || 0;
    const groutUnit = document.getElementById('groutUnit').value;
    let groutConverted = groutSize;
    if (groutUnit === 'cm') groutConverted /= 100;
    if (groutUnit === 'in') groutConverted *= 0.0254;
    const adjustedTileLength = tl + groutConverted;
    const adjustedTileWidth = tw + groutConverted;
    const tileArea = adjustedTileLength * adjustedTileWidth;
    const area = l * w;
    const tilesPerBox = parseInt(document.getElementById('tilesPerBox').value) || 1;
    const totalTilesNeeded = Math.ceil((area / tileArea) * 1.10);
    const boxesNeeded = Math.ceil(totalTilesNeeded / tilesPerBox);

    roomData[currentRoom] = { 
      name: rooms[currentRoom], length: l, width: w, tileLength: tl, tileWidth: tw, groutSize, groutUnit, tilesPerBox, area, tileArea, totalTilesNeeded, boxesNeeded
    };

    currentRoom++;
    if (currentRoom < rooms.length) {
      renderRoomDimension();
    } else {
      document.getElementById('page2').classList.add('hidden');
      document.getElementById('previewPage').classList.remove('hidden');
      showPreview();
    }
  }

  function showPreview() {
    const body = document.querySelector('#previewTable tbody');
    body.innerHTML = '';
    roomData.forEach((r, i) => {
      body.innerHTML += `<tr>
        <td>${r.name}</td>
        <td>${r.length.toFixed(2)}</td>
        <td>${r.width.toFixed(2)}</td>
        <td>${(r.tileLength*r.tileWidth).toFixed(3)} m²</td>
        <td>${r.boxesNeeded}</td>
        <td class="action-btn-container">
          <button class="action-btn" onclick="editRoomDimension(${i})">Edit</button>
          <button class="action-btn" onclick="deleteRoom(${i})">Delete</button>
        </td>
      </tr>`;
    });
  }

  function editRoomDimension(index) {
    currentRoom = index;
    document.getElementById('previewPage').classList.add('hidden');
    document.getElementById('page2').classList.remove('hidden');
    renderRoomDimension();
  }

  function deleteRoom(index) {
    rooms.splice(index, 1);
    roomData.splice(index, 1);
    showPreview();
  }

  function requestQuotation() {
    const handler = PaystackPop.setup({
      key: 'pk_test_4267eb88afba104984e24dd30e98880042131088',
      email: user.email,
      amount: 20000,
      currency: 'KES',
      callback: function(response) {
        document.getElementById('previewPage').classList.add('hidden');
        document.getElementById('resultSection').classList.remove('hidden');
        generateQuotation();
        alert('Payment successful: ' + response.reference);
      },
      onClose: function() {
        alert('Transaction cancelled');
      }
    });
    handler.openIframe();
  }

  function generateQuotation() {
    let html = '<table><tr><th>Room</th><th>Area (m²)</th><th>Tile Area (m²)</th><th>Tiles Needed</th><th>Boxes Needed</th></tr>';
    let total = { area: 0, tiles: 0, boxes: 0 };
    roomData.forEach(r => {
      total.area += r.area;
      total.tiles += r.totalTilesNeeded;
      total.boxes += r.boxesNeeded;
      html += `<tr>
        <td>${r.name}</td>
        <td>${r.area.toFixed(2)}</td>
        <td>${r.tileArea.toFixed(3)}</td>
        <td>${r.totalTilesNeeded}</td>
        <td>${r.boxesNeeded}</td>
      </tr>`;
    });
    html += `<tr><th>Total</th><th>${total.area.toFixed(2)}</th><th>-</th><th>${total.tiles}</th><th>${total.boxes}</th></tr></table>`;
    document.getElementById('result').innerHTML = html;
  }

  function restartApp() {
    user = {};
    rooms = [];
    roomData = [];
    currentRoom = 0;
    document.getElementById('resultSection').classList.add('hidden');
    document.getElementById('page1').classList.remove('hidden');
    document.getElementById('fullName').value = '';
    document.getElementById('email').value = '';
    document.getElementById('roomList').innerHTML = '';
    document.getElementById('roomName').value = '';
    document.getElementById('roomDimensionForm').innerHTML = '';
    document.getElementById('previewTable').querySelector('tbody').innerHTML = '';
    document.getElementById('result').innerHTML = '';
  }
</script>
</body>
</html>
